name: Database Migration Check

on:
  pull_request:
    branches: [staging, production]
    paths:
      - 'prisma/schema.prisma'

jobs:
  migration-check:
    name: Migration Safety Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.20.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for breaking schema changes
        run: |
          echo "üîç Checking for breaking database schema changes..."

          # Check if schema exists on base branch (skip for initial deployment)
          if ! git cat-file -e origin/${{ github.base_ref }}:prisma/schema.prisma 2>/dev/null; then
            echo "‚úÖ Initial schema deployment - skipping migration safety check"
            exit 0
          fi

          # Check PR title for v0.0.1 release (most reliable for PR workflows)
          PR_TITLE="${{ github.event.pull_request.title }}"
          if echo "$PR_TITLE" | grep -qi "v0\.0\.1\|Release v0\.0\.1"; then
            echo "‚úÖ v0.0.1 release detected in PR title - skipping migration safety check"
            exit 0
          fi

          # Check PR title for v0.0.2 release (intentional breaking changes for reservation auth)
          if echo "$PR_TITLE" | grep -qi "v0\.0\.2\|Release v0\.0\.2"; then
            echo "‚úÖ v0.0.2 release detected in PR title - skipping migration safety check (breaking changes expected)"
            echo "‚ÑπÔ∏è  This release includes Prisma migrations for reservation authentication"
            exit 0
          fi

          # Check for v0.0.1 tag (initial production release - no data to migrate)
          if git describe --tags --exact-match 2>/dev/null | grep -q "^v0\.0\.1$"; then
            echo "‚úÖ v0.0.1 initial release - skipping migration safety check (no production data)"
            exit 0
          fi

          # Check for v0.0.2 tag (reservation auth migration)
          if git describe --tags --exact-match 2>/dev/null | grep -q "^v0\.0\.2$"; then
            echo "‚úÖ v0.0.2 release - skipping migration safety check (breaking changes expected)"
            exit 0
          fi

          # Check commit message for v0.0.1 marker (for untagged commits)
          if git log -1 --pretty=%B | grep -qi "v0\.0\.1\|Release v0\.0\.1"; then
            echo "‚úÖ v0.0.1 initial release commit - skipping migration safety check"
            exit 0
          fi

          # Check commit message for v0.0.2 marker (for untagged commits)
          if git log -1 --pretty=%B | grep -qi "v0\.0\.2\|Release v0\.0\.2"; then
            echo "‚úÖ v0.0.2 release commit - skipping migration safety check (breaking changes expected)"
            exit 0
          fi

          # Get diff of schema.prisma
          git diff origin/${{ github.base_ref }} HEAD -- prisma/schema.prisma > schema-diff.txt

          # Check for dangerous patterns
          BREAKING_CHANGES=false

          if grep -E "@map\(|@@map\(|@db\." schema-diff.txt | grep -E "^-" > /dev/null; then
            echo "‚ö†Ô∏è  WARNING: Detected renamed columns or tables!"
            echo "This may cause data loss. Please review carefully."
            BREAKING_CHANGES=true
          fi

          if grep -E "^-\s+\w+\s+\w+" schema-diff.txt > /dev/null; then
            echo "‚ö†Ô∏è  WARNING: Detected removed fields!"
            echo "This will cause permanent data loss."
            BREAKING_CHANGES=true
          fi

          if grep -E "onDelete:\s*(Cascade|SetNull)" schema-diff.txt | grep -E "^[\+\-]" > /dev/null; then
            echo "‚ö†Ô∏è  WARNING: Detected cascade delete changes!"
            echo "This may affect referential integrity."
            BREAKING_CHANGES=true
          fi

          if [ "$BREAKING_CHANGES" = true ]; then
            echo ""
            echo "üìã Migration Safety Checklist:"
            echo "  - [ ] Database backup strategy confirmed"
            echo "  - [ ] Migration tested on staging database"
            echo "  - [ ] Rollback plan documented"
            echo "  - [ ] Schema changes reviewed by team"
            echo ""
            echo "‚ö†Ô∏è  Please ensure the above checklist is complete before merging."
            exit 1
          else
            echo "‚úÖ No breaking schema changes detected"
          fi

      - name: Validate Prisma schema
        run: pnpm prisma validate
        env:
          DATABASE_URL: file:./dev.db

      - name: Check Prisma format
        run: |
          pnpm prisma format
          if git diff --exit-code prisma/schema.prisma; then
            echo "‚úÖ Schema is properly formatted"
          else
            echo "‚ùå Schema needs formatting. Run 'pnpm prisma format'"
            exit 1
          fi
