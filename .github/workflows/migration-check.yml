name: Database Migration Check

on:
  pull_request:
    branches: [main]
    paths:
      - 'prisma/schema.prisma'

jobs:
  migration-check:
    name: Migration Safety Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Check for breaking schema changes
        run: |
          echo "Checking for breaking database schema changes..."

          # Check if schema exists on base branch (skip for initial deployment)
          if ! git cat-file -e origin/${{ github.base_ref }}:prisma/schema.prisma 2>/dev/null; then
            echo "Initial schema deployment - skipping migration safety check"
            exit 0
          fi

          # Check PR title for release versions
          PR_TITLE="${{ github.event.pull_request.title }}"
          if echo "$PR_TITLE" | grep -qi "v0\.0\.[12]\|Release v0\.0\.[12]"; then
            echo "Release version detected - skipping migration safety check"
            exit 0
          fi

          # Get diff of schema.prisma
          git diff origin/${{ github.base_ref }} HEAD -- prisma/schema.prisma > schema-diff.txt

          # Check for dangerous patterns
          BREAKING_CHANGES=false

          if grep -E "@map\(|@@map\(|@db\." schema-diff.txt | grep -E "^-" > /dev/null; then
            echo "WARNING: Detected renamed columns or tables!"
            BREAKING_CHANGES=true
          fi

          if grep -E "^-\s+\w+\s+\w+" schema-diff.txt > /dev/null; then
            echo "WARNING: Detected removed fields!"
            BREAKING_CHANGES=true
          fi

          if grep -E "onDelete:\s*(Cascade|SetNull)" schema-diff.txt | grep -E "^[\+\-]" > /dev/null; then
            echo "WARNING: Detected cascade delete changes!"
            BREAKING_CHANGES=true
          fi

          if [ "$BREAKING_CHANGES" = true ]; then
            echo ""
            echo "Migration Safety Checklist:"
            echo "  - [ ] Database backup strategy confirmed"
            echo "  - [ ] Migration tested on staging database"
            echo "  - [ ] Rollback plan documented"
            echo ""
            exit 1
          else
            echo "No breaking schema changes detected"
          fi

      - name: Validate Prisma schema
        run: pnpm prisma validate
        env:
          DATABASE_URL: file:./dev.db

      - name: Check Prisma format
        run: |
          pnpm prisma format
          if git diff --exit-code prisma/schema.prisma; then
            echo "Schema is properly formatted"
          else
            echo "Schema needs formatting. Run 'pnpm prisma format'"
            exit 1
          fi
