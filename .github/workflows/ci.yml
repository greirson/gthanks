name: CI Pipeline

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Fast checks - run on all PRs and pushes (~1.5 min)
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Run linter
        run: pnpm run lint

      - name: Run type checking
        run: pnpm run typecheck

      - name: Check formatting
        run: pnpm run format:check

      - name: Check service layer compliance
        run: pnpm run lint:service-layer

  # Unit tests - run on all PRs and pushes (~1.5 min)
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Run tests
        run: pnpm exec jest --passWithNoTests
        env:
          NODE_ENV: test

  # Build check - runs after quality checks pass (~2 min)
  # Essential: catches Next.js SSR/SSG issues that TypeScript misses
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [quality-checks, unit-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Build application
        run: pnpm run build
        env:
          SKIP_ENV_VALIDATION: true
          DATABASE_URL: file:./data/gthanks.db
          NEXTAUTH_SECRET: build-time-secret-minimum-32-characters-long
          NEXTAUTH_URL: http://localhost:3000

  # E2E smoke tests - run on:
  # 1. Push to main (safety net after merge)
  # 2. PRs targeting main (catch issues BEFORE merge)
  e2e-smoke:
    name: E2E Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'pull_request' && github.base_ref == 'main')

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_DB: gthanks_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          install-playwright: 'true'

      - name: Configure Prisma for PostgreSQL
        run: |
          sed -i 's/provider = "sqlite"/provider = "postgresql"/' prisma/schema.prisma
        shell: bash

      - name: Regenerate Prisma client for PostgreSQL
        run: pnpm run db:generate

      - name: Run E2E smoke tests
        run: pnpm exec playwright test smoke.spec.ts --project=chromium
        env:
          DATABASE_URL: postgresql://postgres:test@localhost:5432/gthanks_test
          NEXTAUTH_SECRET: test-secret-minimum-32-characters-long
          NEXTAUTH_URL: http://localhost:3000

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14
